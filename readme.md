# 租房系统

## 项目概述
这是一个基于Flask的租房系统，提供房源浏览、搜索、收藏、用户管理等功能，并集成了数据可视化和推荐系统。

## 预测模块 (/predict)

预测模块主要负责数据分析和可视化，包括房价走势预测、户型分布统计、小区排名和户型价格分析。

### 房价走势预测 (predict_price_trend)

房价走势预测使用了多项式回归模型，具体实现逻辑如下：

1. 根据区域(region)和板块(block)筛选相关房源数据
2. 提取房源的发布时间和价格作为训练数据
3. 使用sklearn的PolynomialFeatures进行特征工程，将时间转换为多项式特征
4. 使用LinearRegression模型进行训练
5. 预测未来3个月的房价走势
6. 返回实际价格和预测价格的数据点，用于前端绘制图表

预测结果包含两部分：
- 实际价格数据点：根据历史发布的房源价格
- 预测价格数据点：根据模型预测的未来价格走势

### 户型分布统计 (get_room_type_distribution)

户型分布统计分析特定区域内不同户型的占比：

1. 根据区域(region)和板块(block)筛选相关房源数据
2. 对房源按户型(rooms)进行分组并计数
3. 计算每种户型占总数的百分比
4. 返回户型名称和占比数据，用于前端绘制饼图

### 小区排名 (get_top_communities)

小区排名统计分析特定区域内房源数量最多的小区：

1. 根据区域(region)和板块(block)筛选相关房源数据
2. 对房源按小区(block)进行分组并计数
3. 按房源数量降序排序，取前20个小区
4. 返回小区名称和房源数量数据，用于前端绘制柱状图

### 户型价格分析 (get_price_by_room_type)

户型价格分析比较不同户型的价格分布：

1. 根据区域(region)和板块(block)筛选相关房源数据
2. 对房源按户型(rooms)进行分组
3. 计算每种户型的平均价格、最低价格和最高价格
4. 返回户型名称和价格数据，用于前端绘制折线图

## Redis缓存设计

系统使用Redis缓存热点数据，提高访问速度并减轻数据库负载。采用"先更新MySQL，再更新Redis"的策略确保数据一致性。

### 键值设计

所有Redis键都使用前缀`rental_house:`，主要包括以下几类：

1. **热点房源**：`rental_house:hot_houses`
   - 值类型：JSON字符串（房源列表）
   - 缓存策略：随机选择的热门房源
   - 过期时间：1天

2. **高浏览量房源**：`rental_house:high_view_houses`
   - 值类型：JSON字符串（房源列表）
   - 缓存策略：按page_views降序排序的前10个房源
   - 过期时间：1天

3. **用户浏览历史**：`rental_house:user_history:{user_id}`
   - 值类型：列表（房源ID列表）
   - 缓存策略：最近浏览的20个房源ID
   - 过期时间：1天

4. **用户收藏**：`rental_house:user_collection:{user_id}`
   - 值类型：集合（房源ID集合）
   - 缓存策略：用户收藏的所有房源ID
   - 过期时间：1天

5. **推荐数据**：`rental_house:recommend:{user_id}`
   - 值类型：JSON字符串（推荐房源列表）
   - 缓存策略：根据用户浏览历史生成的推荐房源
   - 过期时间：1天

6. **房源详情**：`rental_house:house_detail:{house_id}`
   - 值类型：JSON字符串（房源详细信息）
   - 缓存策略：用户访问过的房源详情
   - 过期时间：1天

### 更新策略

系统采用"先更新MySQL，再更新Redis"的策略，确保数据一致性：

1. **读取数据**：
   - 首先尝试从Redis读取数据
   - 如果Redis中没有数据，则从MySQL读取，并更新到Redis

2. **更新数据**：
   - 先更新MySQL数据库
   - 更新成功后，再更新Redis缓存

3. **异步更新**：
   - 使用异步任务队列处理数据更新
   - 避免更新操作阻塞用户请求

### 异步任务处理

系统使用Python的threading和queue模块实现异步任务处理：

1. **任务队列**：使用queue.Queue存储待处理的任务
2. **工作线程**：后台线程从队列获取任务并执行
3. **任务类型**：
   - 更新热点房源
   - 更新高浏览量房源
   - 更新用户浏览历史
   - 更新用户收藏
   - 更新用户推荐数据
   - 更新房源详情
   - 更新房源浏览量

4. **定期更新**：系统每小时自动更新热点房源和高浏览量房源

### 内存优化

为节省Redis内存使用，系统采取了以下措施：

1. 只缓存必要的字段，而非完整对象
2. 使用合理的数据结构（如列表、集合）
3. 设置适当的过期时间（默认1天）
4. 对于大数据集，只缓存热点数据

elartsearch
redis，mysql，rabbitmq水平扩展，—nginx流浪限制，服务水平扩展，错误重启
